# FactoryFlow Lite ‚Äî Django REST + React + JWT

Demo full-stack para **gestionar √≥rdenes de trabajo e inspecciones** con:

* **Backend:** Django + Django REST Framework + SimpleJWT
* **Frontend:** React (Vite) + React Router + Tailwind + Axios (interceptor JWT)

---

## √çndice

* [Arquitectura y carpetas](#arquitectura-y-carpetas)
* [Requisitos](#requisitos)
* [üöÄ Quickstart (local)](#-quickstart-local)
* [Variables de entorno](#variables-de-entorno)
* [Backend (Django/DRF)](#backend-djangodrf)

  * [Modelos](#modelos)
  * [Autenticaci√≥n JWT](#autenticaci√≥n-jwt)
  * [Permisos](#permisos)
  * [Endpoints](#endpoints)
  * [Admin](#admin)
  * [Migraciones](#migraciones)
* [Frontend (React/Vite)](#frontend-reactvite)

  * [Estructura y rutas](#estructura-y-rutas)
  * [Contexto de Autenticaci√≥n](#contexto-de-autenticaci√≥n)
  * [Servicios Axios](#servicios-axios)
  * [P√°ginas](#p√°ginas)
* [Flujo (30s)](#flujo)
* [Workflow Git y commits](#workflow-git-y-commits)
* [Ideas de mejora](#ideas-de-mejora)

---

## Arquitectura y carpetas

```
factoryflow-lite/
‚îú‚îÄ server/                     # Django + DRF + SimpleJWT
‚îÇ  ‚îú‚îÄ server_core/             # settings, urls, wsgi/asgi
‚îÇ  ‚îú‚îÄ workorders/              # app: modelos, serializers, viewsets, urls
‚îÇ  ‚îú‚îÄ manage.py
‚îÇ  ‚îî‚îÄ .env                     # SECRET_KEY, DEBUG, etc.
‚îÇ
‚îî‚îÄ client/                     # Vite + React + Tailwind + Router + Axios
   ‚îú‚îÄ src/
   ‚îÇ  ‚îú‚îÄ components/           # Navbar, Footer, etc.
   ‚îÇ  ‚îú‚îÄ layout/               # Layout con <Outlet/>
   ‚îÇ  ‚îú‚îÄ pages/                # Home, Login, WorkOrders, WorkOrderDetail
   ‚îÇ  ‚îú‚îÄ routes/               # AppRoutes, RequireAuth
   ‚îÇ  ‚îú‚îÄ services/             # api.js (axios) + workorders.js + inspections.js
   ‚îÇ  ‚îú‚îÄ context/              # AuthContext.jsx
   ‚îÇ  ‚îú‚îÄ App.jsx, main.jsx, index.css
   ‚îÇ  ‚îî‚îÄ ...
   ‚îî‚îÄ vite.config.js
```

---

## Requisitos

* **Python 3.11+**
* **Node 18+** y **npm**
* **Git**

---

## üöÄ Quickstart (local)

### 1) Backend

```bash
cd server
python -m venv venv
# macOS/Linux:
source venv/bin/activate
# Windows (PowerShell):
# .\venv\Scripts\Activate.ps1

pip install -r requirements.txt
# crea el .env (ver secci√≥n "Variables de entorno")
python manage.py makemigrations
python manage.py migrate
python manage.py createsuperuser
python manage.py runserver  # http://127.0.0.1:8000
```

### 2) Frontend

```bash
cd client
npm install
npm run dev  # http://localhost:5173
```

**Orden para probar:**

1. Entra a `http://127.0.0.1:8000/admin` y crea algunos **WorkOrders** / **Inspections** (o usa la UI luego).
2. En el frontend, ve a **/login**, inicia sesi√≥n con tu usuario de Django.
3. Entra a **/workorders** (listado con filtro y paginaci√≥n), **crear/eliminar** √≥rdenes.
4. Detalle en **/workorders/:id**: **editar** t√≠tulo/estaci√≥n/estado y **crear inspecciones**.

---

### Frontend

En este repo dejamos `baseURL` *hardcodeado* a `http://127.0.0.1:8000/api/` en `client/src/services/api.js`.
**Opcional (mejora):** parametrizar con variable Vite:

```js
// client/src/services/api.js
const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL || "http://127.0.0.1:8000/api/",
})
```

Y crear `.env` en `client/`:

```
VITE_API_URL=http://127.0.0.1:8000/api/
```

---

## Backend (Django/DRF)

### Modelos

* **WorkOrder**: `title (str)`, `station (str)`, `status (OPEN|IN_PROGRESS|DONE)`, `created_at`.
* **Inspection**: `work_order (FK)`, `result (OK|FAIL)`, `notes (str|nullable)`, `created_at`.

### Autenticaci√≥n JWT

* **SimpleJWT** emite tokens en `/api/auth/token/` (POST con `username`, `password`).
* El **frontend** guarda `access` en `localStorage` y lo env√≠a como:

  ```
  Authorization: Bearer <access_token>
  ```
* DRF valida el token con `JWTAuthentication` en cada request protegida.

### Permisos

* Vistas protegidas con `IsAuthenticated` para escritura y lectura seg√∫n lo que definiste (en demo: acceso autenticado para CRUD desde frontend).
* Admin Django requiere superusuario.

### Endpoints

```
# Auth (SimpleJWT)
POST /api/auth/token/           -> { access, refresh }
POST /api/auth/token/refresh/   -> { access }

# WorkOrders
GET    /api/workorders/         -> lista (con ?status=OPEN|IN_PROGRESS|DONE & ?page=N)
POST   /api/workorders/         -> crear
GET    /api/workorders/:id/     -> detalle
PATCH  /api/workorders/:id/     -> actualizar parcial (title, station, status)
DELETE /api/workorders/:id/     -> eliminar

# Inspections
GET    /api/inspections/        -> lista (con ?work_order=:id & ?page=N)
POST   /api/inspections/        -> crear
GET    /api/inspections/:id/    -> detalle
PATCH  /api/inspections/:id/    -> actualizar parcial
DELETE /api/inspections/:id/    -> eliminar
```

### Admin

```bash
python manage.py createsuperuser
# navega a http://127.0.0.1:8000/admin/
```

### Migraciones

* **`makemigrations`**: Django detecta cambios en modelos y crea archivos de migraci√≥n (instrucciones para la BD).
* **`migrate`**: ejecuta esas migraciones contra la BD (crea tablas/columnas).

---

## Frontend (React/Vite)

### Estructura y rutas

* **Layout** con **Navbar/Footer** y un `<Outlet/>` para el contenido.
* Rutas (React Router v6):

  * `/` ‚Üí **Home** (centrada, CTA contextual seg√∫n sesi√≥n).
  * `/login` ‚Üí form controlado, llama a `login()` del **AuthContext**.
  * `/workorders` ‚Üí listado con **filtro por estado**, **paginaci√≥n**, **crear** (inline) y **eliminar**.
  * `/workorders/:id` ‚Üí **detalle** con **editar (PATCH)** y **crear inspecciones**.
* **RequireAuth** (guard): si no hay token, redirige a `/login` y guarda `state.from` para volver tras login.

### Contexto de Autenticaci√≥n

* `AuthContext.jsx`:

  * `useState` para `user`, `token`, `loading`.
  * `useEffect` rehidrata `user` cuando cambia `token` (lee `localStorage`).
  * `login(username, password)`: POST a `/api/auth/token/`, guarda `access` en `localStorage` y estado.
  * `logout()`: limpia storage y estado.
* **C√≥mo explicarlo**: ‚ÄúEstado global sin prop-drilling. Persisto token y rehidrato al recargar. Interceptor Axios a√±ade `Authorization` a cada request.‚Äù

### Servicios Axios

* `api.js`: instancia Axios con `baseURL` e **interceptor de request** que a√±ade el JWT si existe.
* `workorders.js`: `list/get/create/patch/delete` (filtros y paginaci√≥n **en backend**).
* `inspections.js`: igual, con filtro `work_order=:id`.

### P√°ginas

* **Home**: texto corto + CTA (`/login` o `/workorders`) + tres tarjetas (√ìrdenes, Inspecciones, Seguridad).
* **Login**: formulario controlado (`useState`), maneja `loading` y `error`, redirige usando `useNavigate` al `from` o `/`.
* **WorkOrders**: filtro por estado, tabla, crear inline (estado inicial `OPEN`), eliminar con confirmaci√≥n, paginaci√≥n coherente con DRF.
* **WorkOrderDetail**: edita `title/station/status` (PATCH), lista inspecciones (filtrado **server-side**), crear inspecci√≥n (optimistic update).

---

**Tailwind + PostCSS (Vite):**

* Usa el setup estable: `postcss.config.js` con `tailwindcss` y `autoprefixer`, e importa `index.css` con:

  ```css
  @tailwind base;
  @tailwind components;
  @tailwind utilities;
  ```

**`ModuleNotFoundError: workorders.urls`**

* Aseg√∫rate de **crear `workorders/urls.py`** e **incluirlo** en `server_core/urls.py`:

  ```python
  path("api/", include("workorders.urls")),
  ```

**`401 Unauthorized` desde el frontend**

* Inicia sesi√≥n en `/login`.
* Revisa que `localStorage` tenga `token`.
* Verifica que `api.js` est√© usando `Authorization: Bearer <token>` (interceptor activo).

**`405 Method Not Allowed`**

* Verifica que el endpoint exista para ese m√©todo (p. ej., `POST` en `workorders/` requiere `WorkOrderViewSet` registrado en router).

**`OperationalError` de migraciones**

* Ejecuta `makemigrations` y `migrate` con el entorno virtual activado.

---

## Flujo (30s)

> ‚ÄúMont√© una API en Django/DRF con JWT (SimpleJWT) para proteger el CRUD de √≥rdenes e inspecciones. En React uso un AuthContext que persiste el token en `localStorage` y un interceptor Axios que lo a√±ade a cada request. Protejo rutas con un guard que redirige a `/login` guardando `state.from`. El listado de √≥rdenes tiene filtros y paginaci√≥n **server-side**; el detalle permite **editar** t√≠tulo/estaci√≥n/estado y **crear inspecciones**. Las creaciones/eliminaciones actualizan la UI en memoria para una UX fluida.‚Äù

---

## Workflow Git y commits

* Ramas:

  * `dev` ‚Üí integraci√≥n,
  * `feature/backend`,
  * `feature/frontend`.
* Convenci√≥n de mensajes:

  * `feat: ‚Ä¶` nuevas features,
  * `fix: ‚Ä¶` correcciones,
  * `docs: ‚Ä¶` documentaci√≥n,
  * `style: ‚Ä¶` estilos/UI,
  * `chore: ‚Ä¶` tareas menores.

**Ejemplos:**

```bash
git commit -m "feat(auth): Axios instance with JWT interceptor and AuthContext login"
git commit -m "feat(frontend): WorkOrders UI with filter, pagination, create & delete"
git commit -m "feat(frontend): WorkOrder detail edit (PATCH) and inspections create"
git commit -m "docs: add README with setup and interview notes"
```

---

## Ideas de mejora

* **Refresh token**: interceptor de **respuesta** que detecte 401 ‚Üí intente `/auth/token/refresh/` ‚Üí reintente la petici√≥n.
* **Roles/permissions** en DRF (p. ej., operadores vs. managers).
* **Tests**: DRF (APITestCase) y React (Vitest/RTL).
* **Docker** (compose para server+client).
* **OpenAPI/Swagger** con `drf-spectacular`.
